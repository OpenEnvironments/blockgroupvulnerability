#! /usr/bin/env python
# -*- coding: utf-8 -*-
"""
# blockgroupvulnerability

## OPPORTUNITY
The US Centers for Disease Control (CDC) publishes a set of percentiles that compare 
geographies by vulnerability across household, socioeconomic, racial/ethnic and housing
themes. These indexes were originally intended to to help public health officials and
emergency response planners identify communities that will need support around an event.
They are generally valuable for any public interest that wants to relate themselves
to needy communities by geography.

The SVI publication, however, is provided at the Census tract level of geographic detail.
The Census' American Community Survey is available down the to the block group level,
however. Recasting the SVI methods at this lower level of geography allows it to be
tied to thousands of demographic variables available.

The *blockgroupvulnerability* dataset attempts to re-apply the CDCs logic for a new
contribution to the Open Environments blockgroup series available on Harvards dataverse
platform.

## DATA

The SVI data publication
 * is keyed by geography (7 cols) where ultimately the Census Tract FIPS code is
         2 State + 3 County + 4 Tract + 2 Tract Decimals
         eg, 56043000301 is 56 Wyoming, 043 Washakie County, Tract 3.01
 * republishes basic demographics called 'adjunct variables' including
        area, population, households and housing units from the ACS
        daytime population taken from LandScan 2020 estimates 
 * derives 23 SVI variables from 50 ACS 5 Year variables
 * with each having an 
         estimate (E_), estimate precentage (EP_),
         margin of error (M_), margin percentage (MP_)
         and flag variable (F_) for those greater than 90% or less than 10%
 * provides the final 4 themes and a composite SVI percentile
 * annually
``
        vars = ['ST', 'STATE', 'ST_ABBR', 'STCNTY', 'COUNTY', 'FIPS', 'LOCATION'] +\
               ['SNGPNT','LIMENG','DISABL','AGE65','AGE17','NOVEH','MUNIT','MOBILE','GROUPQ','CROWD','UNINSUR','UNEMP','POV150','NOHSDP','HBURD','TWOMORE','OTHERRACE','NHPI','MINRTY','HISP','ASIAN','AIAN','AFAM','NOINT'] +\
               ['TOTAL','THEME1','THEME2','THEME3','THEME4'] + \
               ['AREA_SQMI', 'TOTPOP', 'DAYPOP', 'HU', 'HH']
        knowns = vars + \
        [('E_'+v) for v in vars] + \
        [('F_'+v) for v in vars] +\
        [('M_'+v) for v in vars] + \
        [('MP_'+v) for v in vars] +\
        [('EP_'+v) for v in vars] + \
        [('EPL_'+v) for v in vars] + \
        [('RPL_'+v) for v in vars] + \
        [('SPL_'+v) for v in vars]
        [c for c in svitract.columns if c not in knowns]
``
 * The SVI themes range over [0,1] but the CDC uses -999 as an NA value;
     this is set for ~800 or 1% of tracts, because they have no total poulation.
 * The themes are numbered:
        Socioeconomic Status – RPL_THEME1
        Household Characteristics – RPL_THEME2
        Racial & Ethnic Minority Status – RPL_THEME3
        Housing Type & Transportation – RPL_THEME4
 * The themes with their variables and ACS sources are as follows:
 * Unlike Census data, the CDC ranks Puerto Rico and Tribal tracts separately from
     the US otherwise.
 
|Theme|SVI Variable|ACS Table|ACS Variables|
|---------------|------------|--------|---------------------------------------------------------------------------------------|
|Socioeconomic|E_UNINSUR|S2701|S2701_C04_001E|
|Socioeconomic|E_UNEMP|DP03|DP03_0005E|
|Socioeconomic|E_POV150|S1701|S1701_C01_040E|
|Socioeconomic|E_NOHSDP|B06009|B06009_002E|
|Socioeconomic|E_HBURD|S2503|S2503_C01_028E + S2503_C01_032E + S2503_C01_036E + S2503_C01_040E|
|Household|E_SNGPNT|B11012|B11012_010E + B11012_015E|
|Household|E_LIMENG|B16005|B16005_007E + B16005_008E + B16005_012E + B16005_013E + B16005_017E + B16005_018E + B16005_022E + B16005_023E + B16005_029E + B16005_030E + B16005_034E + B16005_035E + B16005_039E + B16005_040E + B16005_044E + B16005_045E|
|Household|E_DISABL|DP02|DP02_0072E|
|Household|E_AGE65|S0101|S0101_C01_030E|
|Household|E_AGE17|B09001|B09001_001E|
|Racial & Ethnic|E_TWOMORE|DP05|DP05_0083E|
|Racial & Ethnic|E_OTHERRACE|DP05|DP05_0082E|
|Racial & Ethnic|E_NHPI|DP05|DP05_0081E|
|Racial & Ethnic|E_MINRTY|DP05|DP05_0071E + DP05_0078E + DP05_0079E + DP05_0080E + DP05_0081E + DP05_0082E + DP05_0083E |
|Racial & Ethnic|E_HISP|DP05|DP05_0071E|
|Racial & Ethnic|E_ASIAN|DP05|DP05_0080E|
|Racial & Ethnic|E_AIAN|DP05|DP05_0079E|
|Racial & Ethnic|E_AFAM|DP05|DP05_0078E|
|Housing|E_NOVEH|DP04|DP04_0058E|
|Housing|E_MUNIT|DP04|DP04_0012E + DP04_0013E|
|Housing|E_MOBILE|DP04|DP04_0014E|
|Housing|E_GROUPQ|B26001|B26001_001E|
|Housing|E_CROWD|DP04|DP04_0078E + DP04_0079E|

The supporting code is maintained on https://github.com/OpenEnvironments/blockgroupvulnerability 
In generally, variable names within the process are taken from the original SVI and ACS documentation.
The variable names in the dataverse publication have the E_ prefix removed, maintaining
the published variables relation to the SVI original.

## MODEL

The SVI publication starts with 23 simple derivations, subtotals and ratios, upon those
the 50 original Census variables. Next the SVI process ranks census geographies
to calculate a rank for each, where Percentile Rank = (Rank-1) / (N-1). The SVI
themes are then calculated at the tract level as an across-the-board sum of the 
percentile ranks of the variables comprising within each theme. Finally, the
overall ranking is taken as the sum of the theme percentile rankings.

The model provided here repeats the CDC's process, but uses the Census block group level
of Census geography rather than the tract level. For context, there are about 85K
tracts in the United States, while there are about 200K block groups. Each tract has
between 1,200 and 8,000 people in it while each block group has between 600 and 3,000.
Block groups are subdivisions of Census tracts.

This level of detail is available for most of the SVI's Census sources, except for 
variables in the ACS Data Profiles and Subject Tables.  These are only available at the 
tract level. In this processing, the block group level inherits the value from its parent
tract. For each variables sourced from ACS Data Profiles and Subject Tables, the block
groups within a tract share the same percentile ranking.

## CITATIONS
Centers for Disease Control and Prevention/ Agency for Toxic Substances and Disease Registry/ Geospatial Research, Analysis, and Services Program. CDC/ATSDR Social Vulnerability Index [Insert 2020, 2018, 2016, 2014, 2010, or 2000] Database [Insert US or State]. https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html. Accessed on November 8, 2022.
U.S. Census Bureau. (2020). 2020 American Community Survey 5-year Estimates.  Retrieved from API calls to https://api.census.gov/data/2017/acs/acs5?get=NAME,B25077_001M&for=state:*
Flanagan, Barry E.; Gregory, Edward W.; Hallisey, Elaine J.; Heitgerd, Janet L.; and Lewis, Brian (2011) "A Social Vulnerability Index for Disaster Management," Journal of Homeland Security and Emergency Management: Vol. 8: Iss. 1, Article 3. DOI: 10.2202/1547-7355.1792 Available at: http://www.bepress.com/jhsem/vol8/iss1/3 
Bryan, Michael B. “Block Group Datasets.” Open Environments Dataverse, Feb. 2022, https://dataverse.harvard.edu/dataverse/openenvironments. 
https://github.com/OpenEnvironments/blockgroupvulnerability
"""

import pandas as pd
import numpy as np
import json
import requests
from datetime import datetime

def blockgroupvulnerability_getSVI(svidir, year, form = 'csv'):
    """
    This function retrieves the original CDC's SVI publication
    for the given year. Its shared as either a CSV file or as
    a geodatabase with one layer. 
    
    :param svidir: The path to the CSV fil or geodb folder.
    """    
    
    # At this time, I cannot find an ftp site or other wget source
    # so the files need to be manually downloaded from:
    # https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html
        
    if form == 'csv':
        svi = pd.read_csv(svidir + year + "//SVI" + year + "_US.csv")
    elif form == 'gdb':
        import geopandas as gpd
        svi = gpd.read_file(svidir + year + "//SVI" + year + "_US")
    else:
        raise ValueError("getSVI form parameter should be 'csv' or 'gdb'")

    themes = ['RPL_THEME1', 'RPL_THEME2', 'RPL_THEME3', 'RPL_THEME4', 'RPL_THEMES']
    
    svi = svi[((svi[themes] != -999).sum(axis=1) == 5)]
    
    return svi


def blockgroupvulnerability_getACS(year):
    """
    This function retrieves the ACS data needed for calculating the SVIs 23 own variables.
    The ACS variables come from Data Profiles, Subject Tables and Detail Tables. Only
    the last of these is available at the block group level, so the first two are joined 
    to it. As a result the tract level Data Profiles and tract level Subject Tables are
    have percentile ranking results shared across the block groups within each tract.    
    """
    states = pd.read_csv('https://raw.githubusercontent.com/OpenEnvironments/core/main/states.csv', dtype=str)
    states['StateFIPS'] = states.StateFIPS.str.zfill(2)

    acsvars = ["B11012_010E","B11012_015E","B16005_007E","B16005_008E","B16005_012E","B16005_013E","B16005_017E","B16005_018E","B16005_022E","B16005_023E","B16005_029E","B16005_030E","B16005_034E","B16005_035E","B16005_039E","B16005_040E","B16005_044E","B16005_045E","DP02_0072E","S0101_C01_030E","B09001_001E","DP04_0058E","DP04_0012E","DP04_0013E","DP04_0014E","B26001_001E","DP04_0078E","DP04_0079E","S2701_C04_001E","DP03_0005E","S1701_C01_040E","B06009_002E","S2503_C01_028E","S2503_C01_032E","S2503_C01_036E","S2503_C01_040E","DP05_0083E","DP05_0082E","DP05_0081E","DP05_0071E","DP05_0078E","DP05_0079E","DP05_0080E","DP05_0081E","DP05_0082E","DP05_0083E","DP05_0071E","DP05_0080E","DP05_0079E","DP05_0078E"]

    vlistchunk = [c for c in ACSVARS if "B" in c]

    detailtables = []
    subjecttables = []
    dataprofiles = []

    print("Getting ACS for state:",end='')
    for state in list(states[~states.CensusName.isna()].StateFIPS):
        print(",",state,end='')
        # Detail Tables
        dtreq = "https://api.census.gov/data/"+year+"/acs/acs5?get=NAME,"
        dtreq += ",".join([c for c in acsvars if "B" in c])
        dtreq += "&for=block%20group:*&in=state:"+state+"&in=county:*&in=tract:*"
        dtreq += "&key=d75043ce01f4feafcc09f2a72ad3c80eb9567598"
        dtresult = requests.get(dtreq)
        detailtables += json.loads(dtresult.text)[1:]
        # Subject Tables
        streq = "https://api.census.gov/data/"+year+"/acs/acs5/subject?get=NAME,"
        streq += ",".join([c for c in acsvars if "S" in c])
        streq += "&for=tract:*&in=state:"+state+"&in=county:*"
        streq += "&key=d75043ce01f4feafcc09f2a72ad3c80eb9567598"
        stresult = requests.get(streq)
        subjecttables += json.loads(stresult.text)[1:]
        # Data Profiles
        dpreq = "https://api.census.gov/data/"+year+"/acs/acs5/profile?get=NAME,"
        dpreq += ",".join([c for c in acsvars if "D" in c])
        dpreq += "&for=tract:*&in=state:"+state+"&in=county:*"
        dpreq += "&key=d75043ce01f4feafcc09f2a72ad3c80eb9567598"
        dpresult = requests.get(dpreq)
        dataprofiles +=  json.loads(dpresult.text)[1:]
    print()

    dt = pd.DataFrame(columns=json.loads(dt.text)[0],data=detailtables)
    st = pd.DataFrame(columns=json.loads(st.text)[0],data=subjecttables)
    dp = pd.DataFrame(columns=json.loads(dp.text)[0],data=dataprofiles)

    tmp = pd.merge(dt,st.drop('NAME',axis=1),on=['state', 'county', 'tract'])
    acs = pd.merge(tmp,dp.drop('NAME',axis=1),on=['state', 'county', 'tract'])
    return acs


def blockgroupvulnerability_derive(svitractdf):
    """
    This function applies the CDC's formulas for each of 23 CDC Variables
    supporting the SVI Themes.    
    """
    svivars = ["sngpnt","limeng","disabl","age65","age17","noveh","munit","mobile","groupq","crowd","uninsur","unemp","pov150","nohsdp","hburd","twomore","nhpi","minrty","hisp","asian","aian","afam"]
    svitractdf['sngpnt']  = svitractdf['B11012_010E'] + svitractdf['B11012_015E']
    svitractdf['limeng']  = svitractdf['B16005_007E'] + svitractdf['B16005_008E'] + svitractdf['B16005_012E'] + svitractdf['B16005_013E'] + svitractdf['B16005_017E'] + svitractdf['B16005_018E'] + svitractdf['B16005_022E'] + svitractdf['B16005_023E'] + svitractdf['B16005_029E'] + svitractdf['B16005_030E'] + svitractdf['B16005_034E'] + svitractdf['B16005_035E'] + svitractdf['B16005_039E'] + svitractdf['B16005_040E'] + svitractdf['B16005_044E'] + svitractdf['B16005_045E']
    svitractdf['disabl']  = svitractdf['DP02_0072E']
    svitractdf['age65']   = svitractdf['S0101_C01_030E']
    svitractdf['age17']   = svitractdf['B09001_001E']
    svitractdf['noveh']   = svitractdf['DP04_0058E']
    svitractdf['munit']   = svitractdf['DP04_0012E'] + svitractdf['DP04_0013E']
    svitractdf['mobile']  = svitractdf['DP04_0014E']
    svitractdf['groupq']  = svitractdf['B26001_001E']
    svitractdf['crowd']   = svitractdf['DP04_0078E'] + svitractdf['DP04_0079E']
    svitractdf['uninsur'] = svitractdf['S2701_C04_001E']
    svitractdf['unemp']   = svitractdf['DP03_0005E']
    svitractdf['pov150']  = svitractdf['S1701_C01_040E']
    svitractdf['nohsdp']  = svitractdf['B06009_002E']
    svitractdf['hburd']   = svitractdf['S2503_C01_028E'] + svitractdf['S2503_C01_032E'] + svitractdf['S2503_C01_036E'] + svitractdf['S2503_C01_040E']
    svitractdf['twomore'] = svitractdf['DP05_0083E']
    svitractdf['otherrace'] = svitractdf['DP05_0082E'] # E_OTHERRACE is no longer included
    svitractdf['nhpi']    = svitractdf['DP05_0081E']
    svitractdf['minrty']  = svitractdf['DP05_0071E'] + svitractdf['DP05_0078E'] + svitractdf['DP05_0079E'] + svitractdf['DP05_0080E'] + svitractdf['DP05_0081E'] + svitractdf['DP05_0082E'] + svitractdf['DP05_0083E'] 
    svitractdf['hisp']    = svitractdf['DP05_0071E']
    svitractdf['asian']   = svitractdf['DP05_0080E']
    svitractdf['aian']    = svitractdf['DP05_0079E']
    svitractdf['afam']    = svitractdf['DP05_0078E']
    svitractdf['noint']   = svitractdf['S2802_C01_001E'] - svitractdf['S2802_C02_001E']

    # Calculate the percentile ranks for each of the SVI Variables
    def percentile_rank(svidf,col,ascending=True):
        """
        This function accepts a dataframe with 2 columns:
            FIPS code is unique key
            col is the column whose value is ranked

        It caclulates the target column's percentile rank given as: 
            Percentile Rank = (Rank-1) / (N-1)

        The function returns a response dataframe that has just the original key, as well as a new
        column prefixed by "PCTRANK_"
        """
        temp = svidf[['FIPS','E_'+col]].sort_values('E_'+col, ascending=ascending)
        temp.reset_index(drop=True, inplace=True)
        temp['RANK_'+col] = temp.index + 1
        temp.drop('E_'+col,axis=1,inplace=True)
        temp['PCTRANK_'+col] = (temp['RANK_'+col] - 1) / (temp.shape[0]-1)
        return temp

    for c in svivars:
        print("Ranking",c)
        rank = percentile_rank(svitract,c)
        svitractsd = pd.merge(svitractdf,rank,on='FIPS',how='inner')

    svitractsd["E_THEME1"] = svitractsd[["PCTRANK_UNINSUR","PCTRANK_UNEMP","PCTRANK_POV150","PCTRANK_NOHSDP","PCTRANK_HBURD"]].sum(axis=1)
    svitractsd["E_THEME2"] = svitractsd[["PCTRANK_SNGPNT","PCTRANK_LIMENG","PCTRANK_DISABL","PCTRANK_AGE65","PCTRANK_AGE17"]].sum(axis=1)1)
    svitractsd["E_THEME3"] = svitractsd[['PCTRANK_TWOMORE','PCTRANK_OTHERRACE','PCTRANK_NHPI','PCTRANK_MINRTY','PCTRANK_HISP','PCTRANK_ASIAN','PCTRANK_AIAN','PCTRANK_AFAM']].sum(axis=1)
    svitractsd["E_THEME4"] = svitractsd[['PCTRANK_NOVEH','PCTRANK_MUNIT','PCTRANK_MOBILE','PCTRANK_GROUPQ','PCTRANK_CROWD']].sum(axis=1)

    for c in ['1','2','3','4']:
        print("Ranking",'THEME'+c)
        rank = percentile_rank(svitract,'THEME'+c)
        svitractsd = pd.merge(svitractdf,rank,on='FIPS',how='inner')

    return svitractdf


def blockgroupvulnerability_write(df,year):
    """
    This function writes the blockgroupvulnerability projection
    to a csv file for publication.    
    """
    pd.to_csv(year + 'blockgroupvulnerability.csv', index=False)
    return None


#if __name__ == '__main__':
def main():
    YEAR = '2020'
    SVIDIR = "D:\\Open Environments\\data\\cdc\\svi\\"
    svitract = blockgroupvulnerability_getSVI(SVIDIR, YEAR, form='csv')
    acsblockgroup = blockgroupvulnerability_getACS(YEAR)
    sviblockgroup = blockgroupvulnerability_derive(acsblockgroup)
    blockgroupvulnerability_write(sviblockgroup,YEAR)
    print('Done')
    